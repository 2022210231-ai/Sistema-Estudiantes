package com.lab.ui;

import com.lab.controller.StudentController;
import com.lab.model.ValidationException;
import com.lab.service.StudentService;
import com.lab.model.StudentModel;

import javax.swing.*;
import java.awt.*;

public class MainFrame extends JFrame {

    private final StudentFormPanel formPanel;
    private final StudentTablePanel tablePanel;

    private final StudentController controller;
    private final StudentService service;

    public MainFrame() {
        super("Sistema de Estudiantes - Profesional");

        // Instancias core
        StudentModel model = new StudentModel();
        service = new StudentService(model);
        controller = new StudentController(service);

        // UI
        formPanel = new StudentFormPanel();
        tablePanel = new StudentTablePanel();

        setLayout(new BorderLayout());
        add(formPanel, BorderLayout.NORTH);
        add(tablePanel, BorderLayout.CENTER);

        setSize(750, 600);
        setLocationRelativeTo(null);
        setDefaultCloseOperation(EXIT_ON_CLOSE);

        // Data inicial
        model.add("Ana", 20);
        model.add("Luis", 22);
        refreshTable();

        // Eventos UI
        initListeners();
    }

    private void initListeners() {
        formPanel.btnAdd.addActionListener(e -> {
            try {
                controller.addStudent(formPanel.tfName.getText(), formPanel.tfAge.getText());
                refreshTable();
                clearForm();
            } catch (ValidationException ex) {
                showError(ex.getMessage());
            }
        });

        formPanel.btnEdit.addActionListener(e -> {
            int id = tablePanel.getSelectedStudentId();
            if (id == -1) {
                showError("Seleccione un registro para editar.");
                return;
            }

            try {
                controller.updateStudent(id, formPanel.tfName.getText(), formPanel.tfAge.getText());
                refreshTable();
                clearForm();
            } catch (ValidationException ex) {
                showError(ex.getMessage());
            }
        });

        formPanel.btnDelete.addActionListener(e -> {
            int id = tablePanel.getSelectedStudentId();
            if (id == -1) {
                showError("Seleccione un registro para eliminar.");
                return;
            }

            int op = JOptionPane.showConfirmDialog(this, "Â¿Eliminar estudiante?", "Confirmar", JOptionPane.YES_NO_OPTION);
            if (op == JOptionPane.YES_OPTION) {
                try {
                    controller.deleteStudent(id);
                    refreshTable();
                } catch (ValidationException ex) {
                    showError(ex.getMessage());
                }
            }
        });
    }

    private void refreshTable() {
        tablePanel.loadData(service.listStudents());
    }

    private void clearForm() {
        formPanel.tfName.setText("");
        formPanel.tfAge.setText("");
    }

    private void showError(String msg) {
        JOptionPane.showMessageDialog(this, msg, "Error", JOptionPane.ERROR_MESSAGE);
    }
}
